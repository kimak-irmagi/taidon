name: e2e-windows-wsl-probe

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: "Happy-path scenario id"
        required: true
        default: hp-psql-chinook
        type: choice
        options:
          - hp-psql-chinook

jobs:
  windows-wsl-happy:
    runs-on: windows-latest
    timeout-minutes: 90
    env:
      SCENARIO_ID: ${{ github.event.inputs.scenario || 'hp-psql-chinook' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: frontend/cli-go/go.mod

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Docker on host
        uses: docker/setup-docker-action@v4

      - name: Set up WSL
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-24.04

      - name: Show host WSL status
        shell: pwsh
        run: |
          wsl --status
          wsl --list --verbose

      - name: Require elevated host session
        shell: pwsh
        run: |
          $isAdmin = (New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
          if (-not $isAdmin) {
            throw "This probe requires Administrator privileges for sqlrs init --snapshot btrfs."
          }

      - name: Fetch Chinook SQL asset (locked)
        shell: pwsh
        run: |
          $dst = Join-Path $env:GITHUB_WORKSPACE "examples\chinook\Chinook_PostgreSql.sql"
          $url = "https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_PostgreSql.sql"
          $expected = "e3fde5c1a5b51a2a91429a702c9ca6e69ba56e6c7f5e112724d70c3d03db695e"

          New-Item -ItemType Directory -Force -Path (Split-Path -Parent $dst) | Out-Null
          Invoke-WebRequest -Uri $url -OutFile $dst

          $actual = (Get-FileHash -Algorithm SHA256 -Path $dst).Hash.ToLowerInvariant()
          if ($actual -ne $expected) {
            throw "Chinook SQL sha256 mismatch: expected=$expected actual=$actual"
          }

      - name: Build windows sqlrs binary
        working-directory: frontend/cli-go
        shell: pwsh
        run: |
          $outDir = Join-Path $env:GITHUB_WORKSPACE "dist\probe\windows-amd64"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $env:CGO_ENABLED = "0"
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          go build -o (Join-Path $outDir "sqlrs.exe") ./cmd/sqlrs

      - name: Build linux sqlrs-engine binary for WSL runtime
        working-directory: backend/local-engine-go
        shell: pwsh
        run: |
          $outDir = Join-Path $env:GITHUB_WORKSPACE "dist\probe\linux-amd64"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $env:CGO_ENABLED = "0"
          $env:GOOS = "linux"
          $env:GOARCH = "amd64"
          go build -o (Join-Path $outDir "sqlrs-engine") ./cmd/sqlrs-engine

      - name: Ensure Docker in WSL distro (prereq)
        shell: wsl-bash {0}
        run: |
          set -euo pipefail
          if ! command -v docker >/dev/null 2>&1; then
            if [ "$(id -u)" -eq 0 ]; then
              apt-get update
              apt-get install -y docker.io
            else
              sudo apt-get update
              sudo apt-get install -y docker.io
            fi
          fi
          if ! docker info >/dev/null 2>&1; then
            if [ "$(id -u)" -eq 0 ]; then
              nohup dockerd --host=unix:///var/run/docker.sock --storage-driver=vfs --iptables=false >/tmp/sqlrs-probe-dockerd.log 2>&1 &
            else
              nohup sudo dockerd --host=unix:///var/run/docker.sock --storage-driver=vfs --iptables=false >/tmp/sqlrs-probe-dockerd.log 2>&1 &
            fi
            ready=0
            for _ in $(seq 1 90); do
              if docker info >/dev/null 2>&1; then
                ready=1
                break
              fi
              sleep 2
            done
            if [ "$ready" != "1" ]; then
              echo "docker daemon did not become ready" >&2
              tail -n 200 /tmp/sqlrs-probe-dockerd.log || true
              exit 1
            fi
          fi
          if [ "$(id -u)" -eq 0 ]; then
            chmod 666 /var/run/docker.sock || true
          else
            sudo chmod 666 /var/run/docker.sock || true
          fi
          docker version

      - name: Run host sqlrs happy-path (btrfs)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $scenario = $env:SCENARIO_ID
          $outDir = Join-Path $env:RUNNER_TEMP "e2e-probe\$scenario"
          $workspaceDir = Join-Path $outDir "workspace"
          $storeRoot = Join-Path $outDir "store"
          $storeImage = Join-Path $storeRoot "btrfs.vhdx"
          $sqlrs = Join-Path $env:GITHUB_WORKSPACE "dist\probe\windows-amd64\sqlrs.exe"
          $engine = Join-Path $env:GITHUB_WORKSPACE "dist\probe\linux-amd64\sqlrs-engine"

          $env:APPDATA = Join-Path $outDir "appdata"
          $env:LOCALAPPDATA = Join-Path $outDir "localappdata"
          $env:SQLRS_STATE_STORE = $storeRoot

          New-Item -ItemType Directory -Force -Path $outDir, $workspaceDir, $storeRoot, $env:APPDATA, $env:LOCALAPPDATA | Out-Null
          Copy-Item -Path (Join-Path $env:GITHUB_WORKSPACE "examples\chinook\*") -Destination $workspaceDir -Recurse -Force
          Copy-Item -Path (Join-Path $env:GITHUB_WORKSPACE "test\e2e\release\hp-psql-chinook\query.sql") -Destination (Join-Path $workspaceDir ".e2e-query.sql") -Force

          $initArgs = @(
            "--workspace", $workspaceDir,
            "init", "local",
            "--engine", $engine,
            "--snapshot", "btrfs",
            "--store", "image", $storeImage,
            "--distro", "Ubuntu-24.04",
            "--no-start"
          )
          $flowArgs = @(
            "--timeout", "15m",
            "--workspace", $workspaceDir,
            "prepare:psql",
            "--image", "postgres:17",
            "--",
            "-f", "prepare.sql",
            "run:psql",
            "--",
            "-At", "-f", ".e2e-query.sql"
          )

          $initCommand = @($sqlrs) + $initArgs
          $flowCommand = @($sqlrs) + $flowArgs
          ($initCommand | ForEach-Object { if ($_ -match '\s') { '"' + ($_ -replace '"', '\"') + '"' } else { $_ } }) -join " " | Out-File -FilePath (Join-Path $outDir "command-init.txt") -Encoding utf8
          ($flowCommand | ForEach-Object { if ($_ -match '\s') { '"' + ($_ -replace '"', '\"') + '"' } else { $_ } }) -join " " | Out-File -FilePath (Join-Path $outDir "command-flow.txt") -Encoding utf8

          Push-Location $workspaceDir
          try {
            & $sqlrs @initArgs 1> (Join-Path $outDir "init-stdout.log") 2> (Join-Path $outDir "init-stderr.log")
            if ($LASTEXITCODE -ne 0) {
              throw "init local --snapshot btrfs failed with exit code $LASTEXITCODE"
            }

            wsl.exe -d Ubuntu-24.04 -- bash -lc "docker version" 1> (Join-Path $outDir "docker-version.txt") 2> (Join-Path $outDir "dockerd.log")
            if ($LASTEXITCODE -ne 0) {
              throw "wsl docker prereq check failed with exit code $LASTEXITCODE"
            }

            & $sqlrs @flowArgs 1> (Join-Path $outDir "raw-stdout.log") 2> (Join-Path $outDir "raw-stderr.log")
            if ($LASTEXITCODE -ne 0) {
              throw "prepare/run flow failed with exit code $LASTEXITCODE"
            }
          } finally {
            Pop-Location
          }

      - name: Normalize and compare golden output
        shell: pwsh
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP "e2e-probe\$env:SCENARIO_ID"
          node scripts/e2e-release/normalize-output.mjs `
            --scenario "$env:SCENARIO_ID" `
            --scenarios "test/e2e/release/scenarios.json" `
            --input "$outDir/raw-stdout.log" `
            --output "$outDir/normalized-stdout.log"

          node scripts/e2e-release/compare-golden.mjs `
            --expected "test/e2e/release/hp-psql-chinook/golden.txt" `
            --actual "$outDir/normalized-stdout.log" `
            --diff "$outDir/diff.log"

      - name: Collect WSL dockerd diagnostics
        if: always()
        shell: pwsh
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP "e2e-probe\$env:SCENARIO_ID"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          wsl.exe -d Ubuntu-24.04 -- bash -lc "test -f /tmp/sqlrs-probe-dockerd.log && cat /tmp/sqlrs-probe-dockerd.log || true" `
            1> (Join-Path $outDir "dockerd-wsl.log") `
            2> $null

      - name: Upload probe diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-windows-wsl-probe-${{ env.SCENARIO_ID }}
          if-no-files-found: warn
          include-hidden-files: true
          path: ${{ runner.temp }}/e2e-probe/${{ env.SCENARIO_ID }}

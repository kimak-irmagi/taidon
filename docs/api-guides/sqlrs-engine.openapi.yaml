openapi: 3.1.0
info:
  title: The sqlrs engine API
  version: 0.1.0
  description: |
    Local sqlrs engine HTTP API (MVP).
    This file is the design source of truth for the engine API.
  license:
    name: Apache-2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
security:
  - bearerAuth: []
servers:
  - url: http://127.0.0.1:{port}
    description: Local engine endpoint (from engine.json)
    variables:
      port:
        default: "8080"
paths:
  /v1/health:
    get:
      operationId: getHealth
      summary: Engine health check
      description: Returns engine status. No auth required.
      tags:
        - health
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "405":
          description: Method not allowed
  /v1/prepare-jobs:
    get:
      operationId: listPrepareJobs
      summary: List prepare jobs
      description: Returns prepare jobs.
      tags:
        - prepare
      parameters:
        - in: query
          name: job
          schema:
            type: string
          description: Filter by job id prefix.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PrepareJobEntry"
            application/x-ndjson:
              schema:
                type: string
                description: Newline-delimited JSON stream of PrepareJobEntry objects.
        "400":
          description: Invalid filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
    post:
      operationId: createPrepareJob
      summary: Start a prepare job
      description: |
        Starts a prepare job and returns a job reference.
        The engine enforces deterministic defaults for `psql` (`-X` and
        `-v ON_ERROR_STOP=1`) and rejects connection flags.
        When `plan_only` is true, the job computes a plan and does not create
        an instance; the plan tasks are returned in the job status.
      tags:
        - prepare
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PrepareJobRequest"
      responses:
        "201":
          description: Created
          headers:
            Location:
              schema:
                type: string
              description: Canonical job status URL.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrepareJobAccepted"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/prepare-jobs/{jobId}:
    get:
      operationId: getPrepareJob
      summary: Get prepare job status
      description: Returns job status and result when available.
      tags:
        - prepare
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrepareJobStatus"
        "401":
          description: Unauthorized
        "400":
          description: Invalid prefix filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
    delete:
      operationId: deletePrepareJob
      summary: Delete a prepare job
      description: |
        Deletes a prepare job by id. This operation is idempotent.
        By default, jobs with started tasks are blocked unless `force` is set.
      tags:
        - prepare
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
        - in: query
          name: force
          schema:
            type: boolean
          description: Allow deletion of jobs with started tasks.
        - in: query
          name: dry_run
          schema:
            type: boolean
          description: |
            Return the deletion tree without making changes.
            When true, the response is always 200 and `outcome` indicates whether
            deletion would succeed.
      responses:
        "200":
          description: OK (deleted or dry-run result)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Blocked by safety rules (dry_run=false only)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
  /v1/prepare-jobs/{jobId}/cancel:
    post:
      operationId: cancelPrepareJob
      summary: Cancel a prepare job
      description: |
        Requests cancellation for a queued or running prepare job.
        The operation is idempotent:
        - `202 Accepted` when cancellation is requested for `queued` or `running`.
        - `200 OK` when the job is already terminal (`succeeded`, `failed`).
      tags:
        - prepare
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Cancellation requested
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrepareJobStatus"
        "200":
          description: Already terminal
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrepareJobStatus"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/prepare-jobs/{jobId}/events:
    get:
      operationId: streamPrepareJobEvents
      summary: Stream prepare job events
      description: |
        Streams job events as NDJSON.
        Clients may request a partial stream using an events-based range; if the
        server does not honor the range request, it returns a full 200 response.
      tags:
        - prepare
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
        - in: header
          name: Range
          required: false
          schema:
            type: string
          description: |
            Optional events-based range request, e.g. `events=10-` or `events=10-24`.
            When supported, the server responds with 206 and `Content-Range: events`.
      responses:
        "200":
          description: OK
          headers:
            Accept-Ranges:
              schema:
                type: string
              description: Range unit support (e.g. `events`).
          content:
            application/x-ndjson:
              schema:
                type: array
                description: Newline-delimited JSON stream of PrepareJobEvent objects.
                items:
                  $ref: "#/components/schemas/PrepareJobEvent"
        "206":
          description: Partial Content (events range)
          headers:
            Content-Range:
              schema:
                type: string
              description: |
                Events range returned, e.g. `events 10-24/100` or `events 10-*/100`.
            Accept-Ranges:
              schema:
                type: string
              description: Range unit support (e.g. `events`).
          content:
            application/x-ndjson:
              schema:
                type: array
                description: Newline-delimited JSON stream of PrepareJobEvent objects.
                items:
                  $ref: "#/components/schemas/PrepareJobEvent"
        "401":
          description: Unauthorized
        "400":
          description: Invalid prefix filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
        "416":
          description: Requested range not satisfiable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/tasks:
    get:
      operationId: listTasks
      summary: List tasks
      description: Returns task queue entries across jobs.
      tags:
        - tasks
      parameters:
        - in: query
          name: job
          schema:
            type: string
          description: Filter by job id (exact match).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskEntry"
            application/x-ndjson:
              schema:
                type: string
                description: Newline-delimited JSON stream of TaskEntry objects.
        "400":
          description: Invalid filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
  /v1/config:
    get:
      operationId: getConfig
      summary: Get server config
      description: |
        Returns the server configuration.
        When `path` is provided, returns the value at that path.
        When `effective` is true, defaults are applied before returning the value.
      tags:
        - config
      parameters:
        - in: query
          name: path
          required: false
          schema:
            type: string
          description: JS-style path (e.g. `orchestrator.jobs.maxIdentical`).
        - in: query
          name: effective
          required: false
          schema:
            type: boolean
          description: Return value after applying defaults.
      responses:
        "200":
          description: Config value or full config object.
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ConfigValue"
                  - $ref: "#/components/schemas/ConfigMap"
        "400":
          description: Invalid path
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Path not found
    patch:
      operationId: setConfig
      summary: Set config value
      description: |
        Sets a configuration value by path.
        The value is validated against the server schema and semantic rules.
      tags:
        - config
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfigSetRequest"
      responses:
        "200":
          description: Updated config value.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigValue"
        "400":
          description: Invalid value
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
    delete:
      operationId: removeConfig
      summary: Remove config value
      description: |
        Removes a configuration value by path.
      tags:
        - config
      parameters:
        - in: query
          name: path
          required: true
          schema:
            type: string
          description: JS-style path (e.g. `orchestrator.jobs.maxIdentical`).
        - in: query
          name: effective
          required: false
          schema:
            type: boolean
          description: Return value after applying defaults.
      responses:
        "200":
          description: Updated config value.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigValue"
        "400":
          description: Invalid path
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Path not found
  /v1/config/schema:
    get:
      operationId: getConfigSchema
      summary: Get config schema
      description: Returns the JSON Schema for server config validation.
      tags:
        - config
      responses:
        "200":
          description: JSON Schema
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigSchema"
        "401":
          description: Unauthorized
  /v1/names:
    get:
      operationId: listNames
      summary: List names
      description: Returns name bindings.
      tags:
        - names
      parameters:
        - in: query
          name: instance
          schema:
            type: string
          description: Filter by instance id.
        - in: query
          name: state
          schema:
            type: string
          description: Filter by state id.
        - in: query
          name: image
          schema:
            type: string
          description: Filter by base image id.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/NameEntry"
            application/x-ndjson:
              schema:
                type: string
                description: Newline-delimited JSON stream of NameEntry objects.
        "401":
          description: Unauthorized
  /v1/names/{name}:
    get:
      operationId: getName
      summary: Get a name binding
      description: Returns a single name binding.
      tags:
        - names
      parameters:
        - in: path
          name: name
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NameEntry"
        "404":
          description: Not found
        "401":
          description: Unauthorized
  /v1/instances:
    get:
      operationId: listInstances
      summary: List instances
      description: Returns instances.
      tags:
        - instances
      parameters:
        - in: query
          name: id_prefix
          schema:
            type: string
            pattern: "^[0-9a-fA-F]{8,}$"
          description: Case-insensitive hex id prefix (min 8 chars).
        - in: query
          name: state
          schema:
            type: string
          description: Filter by state id.
        - in: query
          name: image
          schema:
            type: string
          description: Filter by base image id.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/InstanceEntry"
            application/x-ndjson:
              schema:
                type: string
                description: Newline-delimited JSON stream of InstanceEntry objects.
        "400":
          description: Invalid filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
  /v1/instances/{instanceId}:
    get:
      operationId: getInstance
      summary: Get an instance
      description: |
        Returns a single instance by id. If the path segment does not match the
        instance id format, it is treated as a name alias. If it matches the id
        format, the engine first attempts id lookup, then falls back to name.
        When resolved by name, the response is a temporary redirect to the
        canonical id-based URL.
      tags:
        - instances
      parameters:
        - in: path
          name: instanceId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InstanceEntry"
        "307":
          description: Temporary redirect to canonical instance id URL
          headers:
            Location:
              schema:
                type: string
              description: Canonical instance URL.
        "404":
          description: Not found
        "401":
          description: Unauthorized
    delete:
      operationId: deleteInstance
      summary: Delete an instance
      description: |
        Deletes a single instance by id. This operation is idempotent.
        The response includes a deletion tree with blocked reasons when removal
        is not possible.
      tags:
        - instances
      parameters:
        - in: path
          name: instanceId
          required: true
          schema:
            type: string
        - in: query
          name: force
          schema:
            type: boolean
          description: Ignore active connections.
        - in: query
          name: dry_run
          schema:
            type: boolean
          description: |
            Return the deletion tree without making changes.
            When true, the response is always 200 and `outcome` indicates whether
            deletion would succeed.
      responses:
        "200":
          description: OK (deleted or dry-run result)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Blocked by safety rules (dry_run=false only)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
  /v1/runs:
    post:
      operationId: runCommand
      summary: Run a command against an instance
      description: |
        Executes a run kind command against an existing instance and streams
        stdout/stderr/exit events. The stream may also include log events for
        instance recovery when a missing container is recreated. If `command`
        is omitted, the default command for the selected kind is used.
      tags:
        - run
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunRequest"
      responses:
        "200":
          description: Streamed run output
          content:
            application/x-ndjson:
              schema:
                $ref: "#/components/schemas/RunEvent"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Instance not found or expired
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Conflicting run arguments
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/states:
    get:
      operationId: listStates
      summary: List states
      description: Returns states.
      tags:
        - states
      parameters:
        - in: query
          name: id_prefix
          schema:
            type: string
            pattern: "^[0-9a-fA-F]{8,}$"
          description: Case-insensitive hex id prefix (min 8 chars).
        - in: query
          name: kind
          schema:
            type: string
          description: Filter by prepare kind.
        - in: query
          name: image
          schema:
            type: string
          description: Filter by base image id.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StateEntry"
            application/x-ndjson:
              schema:
                type: string
                description: Newline-delimited JSON stream of StateEntry objects.
        "400":
          description: Invalid filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
  /v1/states/{stateId}:
    get:
      operationId: getState
      summary: Get a state
      description: Returns a single state.
      tags:
        - states
      parameters:
        - in: path
          name: stateId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StateEntry"
        "404":
          description: Not found
        "401":
          description: Unauthorized
    delete:
      operationId: deleteState
      summary: Delete a state
      description: |
        Deletes a single state by id. This operation is idempotent.
        By default, the state must have no descendants. When `recurse` is set,
        the engine returns a full deletion tree and only deletes when all nodes
        are allowed. Partial deletion is not performed.
      tags:
        - states
      parameters:
        - in: path
          name: stateId
          required: true
          schema:
            type: string
        - in: query
          name: recurse
          schema:
            type: boolean
          description: Allow removal of descendant states and instances.
        - in: query
          name: force
          schema:
            type: boolean
          description: Ignore active connections.
        - in: query
          name: dry_run
          schema:
            type: boolean
          description: |
            Return the deletion tree without making changes.
            When true, the response is always 200 and `outcome` indicates whether
            deletion would succeed.
      responses:
        "200":
          description: OK (deleted or dry-run result)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Blocked by safety rules (dry_run=false only)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: token
  schemas:
    HealthResponse:
      type: object
      additionalProperties: false
      required:
        - ok
        - version
        - instanceId
        - pid
      properties:
        ok:
          type: boolean
          description: True if the engine is healthy.
        version:
          type: string
          description: Engine version string.
        instanceId:
          type: string
          description: Unique engine instance identifier.
        pid:
          type: integer
          format: int32
          description: Engine process id.
      examples:
        - ok: true
          version: dev
          instanceId: 9f4d2d4b6c1a4a4ea2d39d1f7b0d8a21
          pid: 12345
    PrepareJobRequest:
      oneOf:
        - $ref: "#/components/schemas/PrepareJobRequestPsql"
      discriminator:
        propertyName: prepare_kind
        mapping:
          psql: "#/components/schemas/PrepareJobRequestPsql"
    PrepareJobRequestPsql:
      type: object
      additionalProperties: false
      required:
        - prepare_kind
        - image_id
        - psql_args
      properties:
        prepare_kind:
          type: string
          enum: [psql]
          description: Prepare adapter kind.
        image_id:
          type: string
          description: Base Docker image id to use.
        psql_args:
          type: array
          description: |
            Arguments passed to `psql` (excluding connection flags). Argument
            ordering is preserved. File paths must be absolute.
          items:
            type: string
        stdin:
          type: string
          description: SQL content to use for stdin when `psql_args` includes `-f -`.
        plan_only:
          type: boolean
          description: When true, only the plan is computed and no instance is created.
    ConfigSetRequest:
      type: object
      additionalProperties: false
      required:
        - path
        - value
      properties:
        path:
          type: string
          description: JS-style path (e.g. `orchestrator.jobs.maxIdentical`).
        value:
          $ref: "#/components/schemas/JSONValue"
    ConfigValue:
      type: object
      additionalProperties: false
      required:
        - path
        - value
      properties:
        path:
          type: string
        value:
          $ref: "#/components/schemas/JSONValue"
    ConfigMap:
      type: object
      additionalProperties: true
      description: Full server config object.
    ConfigSchema:
      type: object
      additionalProperties: true
      description: JSON Schema for config validation.
    JSONValue:
      oneOf:
        - type: "null"
        - type: string
        - type: number
        - type: integer
        - type: boolean
        - type: object
          additionalProperties: true
        - type: array
          items: {}
    PreparePlanTask:
      oneOf:
        - $ref: "#/components/schemas/PreparePlanTaskPlan"
        - $ref: "#/components/schemas/PreparePlanTaskResolveImage"
        - $ref: "#/components/schemas/PreparePlanTaskStateExecute"
        - $ref: "#/components/schemas/PreparePlanTaskPrepareInstance"
      discriminator:
        propertyName: type
        mapping:
          plan: "#/components/schemas/PreparePlanTaskPlan"
          resolve_image: "#/components/schemas/PreparePlanTaskResolveImage"
          state_execute: "#/components/schemas/PreparePlanTaskStateExecute"
          prepare_instance: "#/components/schemas/PreparePlanTaskPrepareInstance"
    PreparePlanTaskInput:
      type: object
      additionalProperties: false
      required:
        - kind
        - id
      properties:
        kind:
          type: string
          enum: [image, state]
        id:
          type: string
    PreparePlanTaskPlan:
      type: object
      additionalProperties: false
      required:
        - task_id
        - type
        - planner_kind
      properties:
        task_id:
          type: string
        type:
          type: string
          enum: [plan]
        planner_kind:
          type: string
    PreparePlanTaskResolveImage:
      type: object
      additionalProperties: false
      required:
        - task_id
        - type
        - image_id
        - resolved_image_id
      properties:
        task_id:
          type: string
        type:
          type: string
          enum: [resolve_image]
        image_id:
          type: string
        resolved_image_id:
          type: string
    PreparePlanTaskStateExecute:
      type: object
      additionalProperties: false
      required:
        - task_id
        - type
        - input
        - task_hash
        - output_state_id
        - cached
      properties:
        task_id:
          type: string
        type:
          type: string
          enum: [state_execute]
        input:
          $ref: "#/components/schemas/PreparePlanTaskInput"
        task_hash:
          type: string
        output_state_id:
          type: string
        cached:
          type: boolean
    PreparePlanTaskPrepareInstance:
      type: object
      additionalProperties: false
      required:
        - task_id
        - type
        - input
        - instance_mode
      properties:
        task_id:
          type: string
        type:
          type: string
          enum: [prepare_instance]
        input:
          $ref: "#/components/schemas/PreparePlanTaskInput"
        instance_mode:
          type: string
          enum: [ephemeral]
    PrepareJobAccepted:
      type: object
      additionalProperties: false
      required:
        - job_id
        - status_url
      properties:
        job_id:
          type: string
          description: Prepare job id.
        status_url:
          type: string
          description: URL for job status polling.
        events_url:
          type: string
          description: URL for job event streaming.
        status:
          type: string
          enum: [queued]
    PrepareJobStatus:
      type: object
      additionalProperties: false
      required:
        - job_id
        - status
        - prepare_kind
        - image_id
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [queued, running, succeeded, failed]
        prepare_kind:
          type: string
        image_id:
          type: string
        plan_only:
          type: boolean
          description: True when the job computes a plan only.
        prepare_args_normalized:
          type: string
          description: Normalized prepare arguments (when available).
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        finished_at:
          type: string
          format: date-time
        tasks:
          type: array
          description: Present when the plan is available (plan-only or planned job).
          items:
            $ref: "#/components/schemas/PreparePlanTask"
        result:
          anyOf:
            - $ref: "#/components/schemas/PrepareJobResult"
            - type: "null"
        error:
          anyOf:
            - $ref: "#/components/schemas/ErrorResponse"
            - type: "null"
    PrepareJobEntry:
      type: object
      additionalProperties: false
      required:
        - job_id
        - status
        - prepare_kind
        - image_id
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [queued, running, succeeded, failed]
        prepare_kind:
          type: string
        image_id:
          type: string
        plan_only:
          type: boolean
          description: True when the job computes a plan only.
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        finished_at:
          type: string
          format: date-time
    PrepareJobEvent:
      type: object
      additionalProperties: false
      required:
        - type
        - ts
      properties:
        type:
          type: string
          enum: [status, log, result, error, task]
        ts:
          type: string
          format: date-time
        task_id:
          type: string
          description: Present for task status events.
        status:
          type: string
          enum: [queued, running, succeeded, failed]
        message:
          type: string
        result:
          $ref: "#/components/schemas/PrepareJobResult"
        error:
          $ref: "#/components/schemas/ErrorResponse"
    PrepareJobResult:
      type: object
      additionalProperties: false
      required:
        - dsn
        - instance_id
        - state_id
        - image_id
        - prepare_kind
        - prepare_args_normalized
      properties:
        dsn:
          type: string
          description: DSN for the prepared instance.
        instance_id:
          type: string
        state_id:
          type: string
        image_id:
          type: string
        prepare_kind:
          type: string
        prepare_args_normalized:
          type: string
    RunRequest:
      type: object
      additionalProperties: false
      required:
        - instance_ref
        - kind
        - args
      properties:
        instance_ref:
          type: string
          description: Instance id or name.
        kind:
          type: string
          enum: [psql, pgbench]
        command:
          type:
            - string
            - "null"
          description: Optional command; defaults to the run kind command.
        args:
          type: array
          description: Command arguments; applies to the default command when `command` is omitted. Ignored when `steps` is provided.
          items:
            type: string
        stdin:
          type:
            - string
            - "null"
          description: Optional stdin payload for the run command.
        steps:
          type: array
          description: Optional psql run steps (mutually exclusive with args/stdin).
          items:
            $ref: "#/components/schemas/RunStep"
    RunStep:
      type: object
      additionalProperties: false
      required:
        - args
      properties:
        args:
          type: array
          items:
            type: string
        stdin:
          type:
            - string
            - "null"
          description: Optional stdin payload for this step.
    RunEvent:
      type: object
      additionalProperties: false
      required:
        - type
        - ts
      properties:
        type:
          type: string
          enum: [start, stdout, stderr, exit, error, log]
        ts:
          type: string
          format: date-time
        instance_id:
          type: string
          description: Present for start events.
        data:
          type: string
          description: Output chunk for stdout/stderr events or log message text.
        exit_code:
          type: integer
          format: int32
          description: Process exit code for exit events.
        error:
          $ref: "#/components/schemas/ErrorResponse"
    TaskEntry:
      type: object
      additionalProperties: false
      required:
        - task_id
        - job_id
        - type
        - status
      properties:
        task_id:
          type: string
        job_id:
          type: string
        type:
          type: string
          enum: [plan, resolve_image, state_execute, prepare_instance]
        status:
          type: string
          enum: [queued, running, succeeded, failed]
        planner_kind:
          type: string
        input:
          $ref: "#/components/schemas/PreparePlanTaskInput"
        task_hash:
          type: string
        output_state_id:
          type: string
        cached:
          type: boolean
        instance_mode:
          type: string
          enum: [ephemeral]
        image_id:
          type: string
        resolved_image_id:
          type: string
    DeleteResult:
      type: object
      additionalProperties: false
      required:
        - dry_run
        - outcome
        - root
      properties:
        dry_run:
          type: boolean
        outcome:
          type: string
          enum: [deleted, would_delete, blocked]
        root:
          $ref: "#/components/schemas/DeleteTreeNode"
    DeleteTreeNode:
      type: object
      additionalProperties: false
      required:
        - kind
        - id
      properties:
        kind:
          type: string
          enum: [state, instance, job]
        id:
          type: string
        connections:
          type: integer
          format: int32
          minimum: 0
          description: Active connections (instances only).
        runtime_id:
          type: string
          description: Runtime/container identifier for instance nodes.
        blocked:
          type: string
          enum: [active_connections, active_tasks, has_descendants, blocked_by_descendant]
          description: Reason the node cannot be deleted.
        children:
          type: array
          items:
            $ref: "#/components/schemas/DeleteTreeNode"
    ErrorResponse:
      type: object
      additionalProperties: false
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: string
    NameEntry:
      type: object
      additionalProperties: false
      required:
        - name
        - image_id
        - state_id
        - status
      properties:
        name:
          type: string
        instance_id:
          type:
            - string
            - "null"
        image_id:
          type: string
        state_id:
          type: string
        state_fingerprint:
          type: string
        status:
          type: string
          enum: [active, missing, expired]
        last_used_at:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
    InstanceEntry:
      type: object
      additionalProperties: false
      required:
        - instance_id
        - image_id
        - state_id
        - created_at
        - status
      properties:
        instance_id:
          type: string
        image_id:
          type: string
        state_id:
          type: string
        name:
          type:
            - string
            - "null"
        created_at:
          type: string
          format: date-time
        expires_at:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
        status:
          type: string
          enum: [active, expired, orphaned]
    StateEntry:
      type: object
      additionalProperties: false
      required:
        - state_id
        - image_id
        - prepare_kind
        - prepare_args_normalized
        - created_at
        - refcount
      properties:
        state_id:
          type: string
        parent_state_id:
          anyOf:
            - type: string
            - type: "null"
          description: Parent state id (null for roots).
        image_id:
          type: string
        prepare_kind:
          type: string
        prepare_args_normalized:
          type: string
        created_at:
          type: string
          format: date-time
        size_bytes:
          type: integer
          format: int64
        refcount:
          type: integer
          format: int32
